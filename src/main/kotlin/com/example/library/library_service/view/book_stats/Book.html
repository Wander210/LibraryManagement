<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chi Ti·∫øt S√°ch - H·ªá Th·ªëng Qu·∫£n L√Ω Th∆∞ Vi·ªán</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 20px;
        }

        .user-info {
            text-align: right;
            font-size: 14px;
        }

        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
        }

        .tab {
            padding: 12px 24px;
            cursor: pointer;
            background: white;
            border: none;
            font-size: 14px;
            color: #495057;
            transition: all 0.3s;
            text-decoration: none;
        }

        .tab:hover {
            background: #e9ecef;
        }

        .tab.active {
            background: #007bff;
            color: white;
        }

        .content {
            padding: 30px;
        }

        .book-detail {
            display: flex;
            gap: 40px;
        }

        .book-image-section {
            flex: 0 0 300px;
        }

        .book-image {
            width: 300px;
            height: 400px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f8f9fa;
            overflow: hidden;
            margin-bottom: 15px;
        }

        .book-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .book-image .placeholder {
            font-size: 48px;
            color: #adb5bd;
        }

        .book-thumbnails {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .thumbnail {
            width: 60px;
            height: 80px;
            border: 2px solid #dee2e6;
            border-radius: 4px;
            cursor: pointer;
            overflow: hidden;
            transition: border-color 0.3s;
        }

        .thumbnail:hover {
            border-color: #007bff;
        }

        .thumbnail.active {
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0,123,255,0.25);
        }

        .thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .book-info-section {
            flex: 1;
        }

        .section-title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 20px;
            color: #333;
            padding-bottom: 10px;
            border-bottom: 2px solid #007bff;
        }

        .info-grid {
            display: grid;
            gap: 15px;
        }

        .info-row {
            display: grid;
            grid-template-columns: 150px 1fr;
            gap: 15px;
            padding: 12px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .info-label {
            font-weight: 600;
            color: #495057;
            font-size: 14px;
        }

        .info-value {
            color: #212529;
            font-size: 14px;
        }

        .description-section {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .description-title {
            font-weight: 600;
            margin-bottom: 10px;
            color: #495057;
            font-size: 16px;
        }

        .description-content {
            color: #6c757d;
            line-height: 1.6;
            font-size: 14px;
        }

        .loading {
            text-align: center;
            padding: 100px;
            color: #6c757d;
            font-size: 18px;
        }

        .error {
            text-align: center;
            padding: 100px;
            color: #dc3545;
            font-size: 18px;
        }

        .back-button {
            display: inline-block;
            padding: 10px 20px;
            background: #6c757d;
            color: white;
            text-decoration: none;
            border-radius: 4px;
            margin-bottom: 20px;
            transition: background 0.3s;
        }

        .back-button:hover {
            background: #5a6268;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #007bff;
            color: white;
        }

        .btn-primary:hover {
            background: #0056b3;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-available {
            background: #d4edda;
            color: #155724;
        }

        .status-unavailable {
            background: #f8d7da;
            color: #721c24;
        }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>H·ªá Th·ªëng Qu·∫£n L√Ω Th∆∞ Vi·ªán</h1>
        <div class="user-info">
            <div>Ng∆∞·ªùi VƒÉn A</div>
            <div>Nh√¢n vi√™n</div>
            <div id="currentDate"></div>
        </div>
    </div>

    <div class="tabs">
        <a href="index.html" class="tab">Nh·∫≠p s√°ch ra</a>
        <a href="defect.html" class="tab">Qu·∫£n l√≠ l·ªói h·ªèng</a>
        <a href="book-stats.html" class="tab">Th·ªëng k√™ s√°ch</a>
    </div>

    <div class="content">
        <div id="bookDetailContainer">
            <div class="loading">ƒêang t·∫£i th√¥ng tin s√°ch...</div>
        </div>
    </div>
</div>

<script>
    // ==================== CONFIG ====================
    const CONFIG = {
        API_BASE_URL: 'http://localhost:8080'
    };

    // ==================== MODEL ====================
    class BookDetailModel {
        constructor() {
            this.book = null;
            this.currentImageIndex = 0;
        }

        setBook(book) {
            this.book = book;
            this.currentImageIndex = 0;
        }

        setCurrentImageIndex(index) {
            this.currentImageIndex = index;
        }

        getCurrentImage() {
            if (!this.book || !this.book.photoUrls || this.book.photoUrls.length === 0) {
                return null;
            }
            return this.book.photoUrls[this.currentImageIndex];
        }

        hasImages() {
            return this.book && this.book.photoUrls && this.book.photoUrls.length > 0;
        }
    }

    // ==================== VIEW ====================
    class BookDetailView {
        constructor() {
            this.elements = {
                currentDate: document.getElementById('currentDate'),
                bookDetailContainer: document.getElementById('bookDetailContainer')
            };
        }

        renderDate() {
            const today = new Date();
            this.elements.currentDate.textContent = today.toLocaleDateString('vi-VN');
        }

        renderBookDetail(book, currentImage) {
            const hasImages = book.photoUrls && book.photoUrls.length > 0;
            const availabilityStatus = book.availableCopies > 0 ? 'available' : 'unavailable';
            const availabilityText = book.availableCopies > 0 ? 'C√≤n s√°ch' : 'H·∫øt s√°ch';

            const html = `
                <div class="book-detail">
                    <div class="book-image-section">
                        <div class="book-image">
                            ${hasImages && currentImage ?
                                `<img src="${this.escapeHtml(currentImage)}" alt="${this.escapeHtml(book.title)}">` :
                                '<div class="placeholder">üìö</div>'
                            }
                        </div>
                        ${hasImages ? `
                            <div class="book-thumbnails" id="thumbnails">
                                ${book.photoUrls.map((url, index) => `
                                    <div class="thumbnail ${index === 0 ? 'active' : ''}" data-index="${index}">
                                        <img src="${this.escapeHtml(url)}" alt="·∫¢nh ${index + 1}">
                                    </div>
                                `).join('')}
                            </div>
                        ` : `
                            <div class="description-title" style="text-align: center; color: #6c757d; font-size: 13px;">
                                M√¥ t·∫£
                            </div>
                            <div class="description-content" style="text-align: center; padding: 15px; background: white; border-radius: 4px; margin-top: 10px;">
                                ${this.escapeHtml(book.description)}
                            </div>
                        `}
                    </div>

                    <div class="book-info-section">
                        <div class="section-title">${this.escapeHtml(book.title)}</div>

                        <div class="info-grid">
                            <div class="info-row">
                                <div class="info-label">M√£ s√°ch:</div>
                                <div class="info-value">${this.escapeHtml(book.id)}</div>
                            </div>

                            <div class="info-row">
                                <div class="info-label">Th·ªÉ lo·∫°i:</div>
                                <div class="info-value">${this.escapeHtml(book.category)}</div>
                            </div>

                            <div class="info-row">
                                <div class="info-label">T√°c gi·∫£:</div>
                                <div class="info-value">${this.escapeHtml(book.author)}</div>
                            </div>

                            <div class="info-row">
                                <div class="info-label">Nh√† s·∫£n xu·∫•t:</div>
                                <div class="info-value">${this.escapeHtml(book.publisher)}</div>
                            </div>

                            <div class="info-row">
                                <div class="info-label">NƒÉm s·∫£n xu·∫•t:</div>
                                <div class="info-value">${book.publicationYear}</div>
                            </div>

                            <div class="info-row">
                                <div class="info-label">S·ªë b·∫£n copy:</div>
                                <div class="info-value">${book.totalOfCopies}</div>
                            </div>

                            <div class="info-row">
                                <div class="info-label">S·ªë b·∫£n c√≥ s·∫µn:</div>
                                <div class="info-value">
                                    ${book.availableCopies}
                                    <span class="status-badge status-${availabilityStatus}">
                                        ${availabilityText}
                                    </span>
                                </div>
                            </div>

                            <div class="info-row">
                                <div class="info-label">Ng√†y t·∫°o:</div>
                                <div class="info-value">${this.formatDateTime(book.createdAt)}</div>
                            </div>
                        </div>

                        ${hasImages ? `
                            <div class="description-section">
                                <div class="description-title">M√¥ t·∫£</div>
                                <div class="description-content">
                                    ${this.escapeHtml(book.description || 'Ch∆∞a c√≥ m√¥ t·∫£ cho cu·ªën s√°ch n√†y.')}
                                </div>
                            </div>
                        ` : ''}

                        <div class="action-buttons">
                            <button class="btn btn-success" onclick="bookDetailController.handleBorrowBook()">
                                M∆∞·ª£n s√°ch
                            </button>
                            <button class="btn btn-primary" onclick="bookDetailController.handleEditBook()">
                                Ch·ªânh s·ª≠a
                            </button>
                        </div>
                    </div>
                </div>
            `;

            this.elements.bookDetailContainer.innerHTML = html;
        }

        updateActiveImage(index) {
            const thumbnails = document.querySelectorAll('.thumbnail');
            thumbnails.forEach((thumb, i) => {
                thumb.classList.toggle('active', i === index);
            });
        }

        renderLoading() {
            this.elements.bookDetailContainer.innerHTML = '<div class="loading">ƒêang t·∫£i th√¥ng tin s√°ch...</div>';
        }

        renderError(message) {
            this.elements.bookDetailContainer.innerHTML = `<div class="error">${this.escapeHtml(message)}</div>`;
        }

        escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        formatDateTime(dateTime) {
            if (!dateTime) return 'N/A';
            const date = new Date(dateTime);
            return date.toLocaleDateString('vi-VN');
        }
    }

    // ==================== CONTROLLER ====================
    class BookDetailController {
        constructor(model, view) {
            this.model = model;
            this.view = view;
            this.init();
        }

        async init() {
            this.view.renderDate();
            const bookId = this.getBookIdFromUrl();

            if (!bookId) {
                this.view.renderError('Kh√¥ng t√¨m th·∫•y m√£ s√°ch trong URL');
                return;
            }

            await this.loadBookDetail(bookId);
        }

        getBookIdFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('id');
        }

        async loadBookDetail(bookId) {
            try {
                this.view.renderLoading();
                const book = await this.fetchBookDetail(bookId);
                this.model.setBook(book);
                this.render();
                this.setupImageGallery();
            } catch (error) {
                console.error('Error loading book detail:', error);
                this.view.renderError('Kh√¥ng th·ªÉ t·∫£i th√¥ng tin s√°ch. Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi API.');
            }
        }

        async fetchBookDetail(bookId) {
            const response = await fetch(`${CONFIG.API_BASE_URL}/api/book-stats/id/${encodeURIComponent(bookId)}`);
            if (!response.ok) {
                throw new Error('Failed to fetch book detail');
            }
            return await response.json();
        }

        setupImageGallery() {
            const thumbnails = document.querySelectorAll('.thumbnail');
            thumbnails.forEach(thumb => {
                thumb.addEventListener('click', (e) => {
                    const index = parseInt(e.currentTarget.dataset.index);
                    this.handleImageChange(index);
                });
            });
        }

        handleImageChange(index) {
            this.model.setCurrentImageIndex(index);
            const newImage = this.model.getCurrentImage();

            // Update main image
            const mainImage = document.querySelector('.book-image img');
            if (mainImage && newImage) {
                mainImage.src = newImage;
            }

            // Update active thumbnail
            this.view.updateActiveImage(index);
        }

        handleBorrowBook() {
            if (!this.model.book) return;
            window.location.href = `borrow-book.html?bookId=${encodeURIComponent(this.model.book.id)}`;
        }

        handleEditBook() {
            if (!this.model.book) return;
            window.location.href = `edit-book.html?id=${encodeURIComponent(this.model.book.id)}`;
        }

        render() {
            const currentImage = this.model.getCurrentImage();
            this.view.renderBookDetail(this.model.book, currentImage);
        }
    }

    // ==================== INIT APP ====================
    let bookDetailController;
    document.addEventListener('DOMContentLoaded', () => {
        const model = new BookDetailModel();
        const view = new BookDetailView();
        bookDetailController = new BookDetailController(model, view);
    });
</script>
</body>
</html>