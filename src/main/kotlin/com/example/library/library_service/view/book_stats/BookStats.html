<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thống Kê Sách - Hệ Thống Quản Lý Thư Viện</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 20px;
        }

        .user-info {
            text-align: right;
            font-size: 14px;
        }

        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
        }

        .tab {
            padding: 12px 24px;
            cursor: pointer;
            background: white;
            border: none;
            font-size: 14px;
            color: #495057;
            transition: all 0.3s;
            text-decoration: none;
        }

        .tab:hover {
            background: #e9ecef;
        }

        .tab.active {
            background: #007bff;
            color: white;
        }

        .filter-section {
            padding: 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }

        .filter-row {
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
        }

        .filter-group {
            position: relative;
        }

        .filter-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 13px;
            font-weight: 600;
            color: #495057;
        }

        .filter-btn {
            padding: 10px 20px;
            background: white;
            border: 1px solid #ced4da;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 120px;
            justify-content: space-between;
        }

        .filter-btn:hover {
            background: #e9ecef;
        }

        .filter-btn.active {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }

        /* Button Thống kê sử dụng cùng màu với tab active */
        #applyFilterBtn {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }

        #applyFilterBtn:hover {
            background: #0056b3;
        }

        .dropdown {
            position: absolute;
            top: calc(100% + 5px);
            left: 0;
            background: white;
            border: 1px solid #ced4da;
            border-radius: 4px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: none;
            z-index: 1000;
            max-height: 300px;
            overflow-y: auto;
            min-width: 120px;
        }

        .dropdown.show {
            display: block;
        }

        .dropdown-item {
            padding: 10px 15px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }

        .dropdown-item:hover {
            background: #f8f9fa;
        }

        .dropdown-item.selected {
            background: #e3f2fd;
            color: #1976d2;
            font-weight: 600;
        }

        .stats-summary {
            display: flex;
            gap: 20px;
            padding: 20px;
            background: white;
            flex-wrap: wrap;
            border-bottom: 1px solid #dee2e6;
        }

        .stat-card {
            padding: 15px 20px;
            border-radius: 6px;
            min-width: 180px;
            text-align: center;
            flex: 1;
        }

        .stat-card.blue {
            background: #e3f2fd;
            color: #1976d2;
        }

        .stat-card.green {
            background: #e8f5e9;
            color: #388e3c;
        }

        .stat-card.orange {
            background: #fff3e0;
            color: #f57c00;
        }

        .stat-card.purple {
            background: #f3e5f5;
            color: #7b1fa2;
        }

        .stat-card .label {
            font-size: 12px;
            margin-bottom: 8px;
        }

        .stat-card .value {
            font-size: 24px;
            font-weight: bold;
        }

        .content {
            padding: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        th {
            background: #f8f9fa;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            font-size: 13px;
            color: #495057;
            border-bottom: 2px solid #dee2e6;
        }

        th.center, td.center {
            text-align: center;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid #dee2e6;
            font-size: 13px;
        }

        tr:hover {
            background: #f8f9fa;
            cursor: pointer;
        }

        .borrow-btn {
            padding: 6px 12px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.3s;
        }

        .borrow-btn:hover {
            background: #218838;
        }

        .pagination {
            display: flex;
            justify-content: center;
            gap: 5px;
            margin-top: 20px;
            padding: 20px;
        }

        .page-btn {
            padding: 8px 12px;
            border: 1px solid #dee2e6;
            background: white;
            cursor: pointer;
            border-radius: 4px;
            font-size: 13px;
        }

        .page-btn:hover {
            background: #f8f9fa;
        }

        .page-btn.active {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }

        .error {
            text-align: center;
            padding: 40px;
            color: #dc3545;
        }

        .arrow-icon {
            font-size: 10px;
        }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>Hệ Thống Quản Lý Thư Viện</h1>
        <div class="user-info">
            <div>Nguyễn Văn A</div>
            <div>Thủ thư</div>
            <div id="currentDate"></div>
        </div>
    </div>

    <div class="tabs">
        <a href="index.html" class="tab">Nhập sách ra</a>
        <a href="defect.html" class="tab">Quản lí lỗi hỏng</a>
        <a href="book-stats.html" class="tab active">Thống kê sách</a>
    </div>

    <div class="filter-section">
        <div class="filter-row">
            <div class="filter-group">
                <label>Năm</label>
                <button class="filter-btn" id="yearBtn">
                    <span id="yearText">Năm</span>
                    <span class="arrow-icon">▼</span>
                </button>
                <div class="dropdown" id="yearDropdown"></div>
            </div>

            <div class="filter-group">
                <label>Quý</label>
                <button class="filter-btn" id="quarterBtn">
                    <span id="quarterText">Quý</span>
                    <span class="arrow-icon">▼</span>
                </button>
                <div class="dropdown" id="quarterDropdown"></div>
            </div>

            <div class="filter-group">
                <label>Tháng</label>
                <button class="filter-btn" id="monthBtn">
                    <span id="monthText">Tháng</span>
                    <span class="arrow-icon">▼</span>
                </button>
                <div class="dropdown" id="monthDropdown"></div>
            </div>

            <div class="filter-group">
                <label style="opacity: 0;">Thống kê</label>
                <button class="filter-btn" id="applyFilterBtn">
                    Thống kê
                </button>
            </div>
        </div>
    </div>

    <div class="stats-summary">
        <div class="stat-card blue">
            <div class="label">Tổng số lượt mượn</div>
            <div class="value" id="totalBorrows">80 (tăng 12%)</div>
        </div>
        <div class="stat-card green">
            <div class="label">Sách phổ biến nhất</div>
            <div class="value" id="mostPopular">Phần tích và thiết kế phần mềm</div>
        </div>
        <div class="stat-card orange">
            <div class="label">Đang được mượn</div>
            <div class="value" id="currentBorrowed">10</div>
        </div>
        <div class="stat-card purple">
            <div class="label">Danh mục phổ biến</div>
            <div class="value" id="popularCategory">Tiểu thuyết</div>
        </div>
    </div>

    <div class="content">
        <div id="tableContainer">
            <div class="loading">Đang tải dữ liệu...</div>
        </div>

        <div class="pagination" id="pagination"></div>
    </div>
</div>

<script>
    // ==================== CONFIG ====================
    const CONFIG = {
        API_BASE_URL: 'http://localhost:8080',
        ITEMS_PER_PAGE: 10,
        CURRENT_YEAR: new Date().getFullYear()
    };

    // ==================== MODEL ====================
    class BookStatsModel {
        constructor() {
            this.stats = [];
            this.summary = null;
            this.filters = {
                year: null,
                quarter: null,
                month: null
            };
            this.currentPage = 1;
        }

        setStats(stats) {
            this.stats = stats;
        }

        setSummary(summary) {
            this.summary = summary;
        }

        setFilter(type, value) {
            this.filters[type] = value;

            // Reset dependent filters
            if (type === 'year') {
                // Keep quarter and month
            } else if (type === 'quarter') {
                this.filters.month = null;
            } else if (type === 'month') {
                this.filters.quarter = null;
            }

            this.currentPage = 1;
        }

        getFilterParams() {
            const params = new URLSearchParams();
            if (this.filters.year) params.append('year', this.filters.year);
            if (this.filters.quarter) params.append('quarter', this.filters.quarter);
            if (this.filters.month) params.append('month', this.filters.month);
            return params.toString();
        }

        setPage(page) {
            this.currentPage = page;
        }

        getPageData() {
            const start = (this.currentPage - 1) * CONFIG.ITEMS_PER_PAGE;
            const end = start + CONFIG.ITEMS_PER_PAGE;
            return this.stats.slice(start, end);
        }

        getTotalPages() {
            return Math.ceil(this.stats.length / CONFIG.ITEMS_PER_PAGE);
        }
    }

    // ==================== VIEW ====================
    class BookStatsView {
        constructor() {
            this.elements = {
                currentDate: document.getElementById('currentDate'),
                yearBtn: document.getElementById('yearBtn'),
                quarterBtn: document.getElementById('quarterBtn'),
                monthBtn: document.getElementById('monthBtn'),
                yearText: document.getElementById('yearText'),
                quarterText: document.getElementById('quarterText'),
                monthText: document.getElementById('monthText'),
                yearDropdown: document.getElementById('yearDropdown'),
                quarterDropdown: document.getElementById('quarterDropdown'),
                monthDropdown: document.getElementById('monthDropdown'),
                tableContainer: document.getElementById('tableContainer'),
                pagination: document.getElementById('pagination'),
                totalBorrows: document.getElementById('totalBorrows'),
                mostPopular: document.getElementById('mostPopular'),
                currentBorrowed: document.getElementById('currentBorrowed'),
                popularCategory: document.getElementById('popularCategory'),
                applyFilterBtn: document.getElementById('applyFilterBtn')
            };
            this.initDropdowns();
        }

        renderDate() {
            const today = new Date();
            this.elements.currentDate.textContent = today.toLocaleDateString('vi-VN');
        }

        initDropdowns() {
            // Year dropdown
            const years = [];
            for (let y = CONFIG.CURRENT_YEAR; y >= 2020; y--) {
                years.push(y);
            }
            this.renderDropdown('year', ['Bỏ trống', ...years]);

            // Quarter dropdown
            this.renderDropdown('quarter', ['Bỏ trống', 1, 2, 3, 4]);

            // Month dropdown
            const months = ['Bỏ trống'];
            for (let m = 1; m <= 12; m++) {
                months.push(m);
            }
            this.renderDropdown('month', months);
        }

        renderDropdown(type, items) {
            const dropdown = this.elements[`${type}Dropdown`];
            dropdown.innerHTML = items.map(item =>
                `<div class="dropdown-item" data-value="${item}">${item}</div>`
            ).join('');
        }

        updateFilterDisplay(type, value) {
            const text = this.elements[`${type}Text`];
            const btn = this.elements[`${type}Btn`];

            if (value === null || value === 'Bỏ trống') {
                text.textContent = type === 'year' ? 'Năm' :
                                   type === 'quarter' ? 'Quý' : 'Tháng';
                btn.classList.remove('active');
            } else {
                text.textContent = value;
                btn.classList.add('active');
            }
        }

        toggleDropdown(type) {
            const dropdown = this.elements[`${type}Dropdown`];
            const allDropdowns = [
                this.elements.yearDropdown,
                this.elements.quarterDropdown,
                this.elements.monthDropdown
            ];

            // Close other dropdowns
            allDropdowns.forEach(d => {
                if (d !== dropdown) d.classList.remove('show');
            });

            dropdown.classList.toggle('show');
        }

        closeAllDropdowns() {
            this.elements.yearDropdown.classList.remove('show');
            this.elements.quarterDropdown.classList.remove('show');
            this.elements.monthDropdown.classList.remove('show');
        }

        renderSummary(summary) {
            if (!summary) return;

            this.elements.totalBorrows.textContent = `${summary.totalBorrowCount}`;
            this.elements.mostPopular.textContent = summary.totalBooks || '0';
            this.elements.currentBorrowed.textContent = summary.totalBorrowCount || '0';
            this.elements.popularCategory.textContent = summary.mostBorrowedCategory || 'N/A';
        }

        renderTable(stats) {
            if (stats.length === 0) {
                this.elements.tableContainer.innerHTML = '<div class="loading">Không có dữ liệu</div>';
                return;
            }

            const tableHTML = `
                <table>
                    <thead>
                        <tr>
                            <th class="center">Hạng</th>
                            <th>Mã sách</th>
                            <th>Tên sách</th>
                            <th>Danh mục</th>
                            <th class="center">Lượt mượn</th>
                            <th class="center">Đang mượn</th>
                            <th class="center">Còn lại</th>
                            <th class="center"></th>
                        </tr>
                    </thead>
                    <tbody>
                        ${stats.map(stat => this.renderTableRow(stat)).join('')}
                    </tbody>
                </table>
            `;

            this.elements.tableContainer.innerHTML = tableHTML;
        }

        renderTableRow(stat) {
            return `
                <tr onclick="bookStatsController.handleRowClick('${this.escapeHtml(stat.bookId)}')">
                    <td class="center">${stat.rank}</td>
                    <td>${this.escapeHtml(stat.bookId)}</td>
                    <td>${this.escapeHtml(stat.bookTitle)}</td>
                    <td>${this.escapeHtml(stat.category)}</td>
                    <td class="center">${stat.borrowCount}</td>
                    <td class="center">${stat.currentBorrowed}</td>
                    <td class="center">${stat.available}</td>
                    <td class="center">
                        <button class="borrow-btn" onclick="event.stopPropagation(); bookStatsController.handleBorrowClick('${this.escapeHtml(stat.bookId)}')">
                            Lượt mượn
                        </button>
                    </td>
                </tr>
            `;
        }

        renderPagination(currentPage, totalPages) {
            if (totalPages <= 1) {
                this.elements.pagination.innerHTML = '';
                return;
            }

            let paginationHTML = '';

            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= currentPage - 1 && i <= currentPage + 1)) {
                    paginationHTML += `
                        <button class="page-btn ${i === currentPage ? 'active' : ''}"
                                data-page="${i}">${i}</button>
                    `;
                } else if (i === currentPage - 2 || i === currentPage + 2) {
                    paginationHTML += '<span style="padding: 8px;">...</span>';
                }
            }

            this.elements.pagination.innerHTML = paginationHTML;
        }

        renderLoading() {
            this.elements.tableContainer.innerHTML = '<div class="loading">Đang tải dữ liệu...</div>';
        }

        renderError(message) {
            this.elements.tableContainer.innerHTML = `<div class="error">${this.escapeHtml(message)}</div>`;
        }

        escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    }

    // ==================== CONTROLLER ====================
    class BookStatsController {
        constructor(model, view) {
            this.model = model;
            this.view = view;
            this.init();
        }

        async init() {
            this.view.renderDate();
            this.setupEventListeners();
            await this.loadData();
        }

        setupEventListeners() {
            // Filter buttons
            this.view.elements.yearBtn.addEventListener('click', () => {
                this.view.toggleDropdown('year');
            });

            this.view.elements.quarterBtn.addEventListener('click', () => {
                this.view.toggleDropdown('quarter');
            });

            this.view.elements.monthBtn.addEventListener('click', () => {
                this.view.toggleDropdown('month');
            });

            // Nút Thống kê
            this.view.elements.applyFilterBtn.addEventListener('click', () => {
                this.loadData();
            });

            // Dropdown items
            this.view.elements.yearDropdown.addEventListener('click', (e) => {
                if (e.target.classList.contains('dropdown-item')) {
                    this.handleFilterChange('year', e.target.dataset.value);
                }
            });

            this.view.elements.quarterDropdown.addEventListener('click', (e) => {
                if (e.target.classList.contains('dropdown-item')) {
                    this.handleFilterChange('quarter', e.target.dataset.value);
                }
            });

            this.view.elements.monthDropdown.addEventListener('click', (e) => {
                if (e.target.classList.contains('dropdown-item')) {
                    this.handleFilterChange('month', e.target.dataset.value);
                }
            });

            // Close dropdowns when clicking outside
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.filter-group')) {
                    this.view.closeAllDropdowns();
                }
            });

            // Pagination
            this.view.elements.pagination.addEventListener('click', (e) => {
                if (e.target.classList.contains('page-btn')) {
                    this.handlePageChange(parseInt(e.target.dataset.page));
                }
            });
        }

        async loadData() {
            try {
                this.view.renderLoading();

                const dateRange = this.getDateRangeFromFilters();
                const stats = await this.fetchStats(dateRange.startDate, dateRange.endDate);
                const rankedStats = this.assignRanks(stats);

                this.model.setStats(rankedStats);
                this.model.setSummary(this.calculateSummary(rankedStats));
                this.render();
            } catch (error) {
                console.error('Error loading data:', error);
                this.view.renderError('Không thể tải dữ liệu. Vui lòng kiểm tra kết nối API.');
            }
        }

        async fetchStats(startDate, endDate) {
            const url = new URL(`${CONFIG.API_BASE_URL}/api/book-stats`);
            url.searchParams.append('startDate', startDate);
            url.searchParams.append('endDate', endDate);

            const response = await fetch(url.toString());
            if (!response.ok) throw new Error('Failed to fetch stats');
            return await response.json();
        }

        /**
         * Chuyển đổi bộ lọc năm / quý / tháng thành khoảng thời gian startDate, endDate (yyyy-MM-dd)
         * Lưu ý: API BookStatsController yêu cầu cả startDate và endDate là bắt buộc.
         */
        getDateRangeFromFilters() {
            const { year, quarter, month } = this.model.filters;

            // Nếu không chọn gì -> lấy toàn bộ khoảng thời gian trong hệ thống (từ 2000 đến hôm nay)
            if (!year && !quarter && !month) {
                const start = new Date(2000, 0, 1);
                const end = new Date();
                return {
                    startDate: this.formatDate(start),
                    endDate: this.formatDate(end)
                };
            }

            // Nếu chọn năm / quý / tháng -> tính theo năm đã chọn (nếu chưa chọn năm thì dùng năm hiện tại)
            const y = year || CONFIG.CURRENT_YEAR;
            let start, end;

            if (month) {
                // Lọc theo tháng
                start = new Date(y, month - 1, 1);
                // ngày 0 của tháng tiếp theo = ngày cuối của tháng hiện tại
                end = new Date(y, month, 0);
            } else if (quarter) {
                // Lọc theo quý
                const startMonth = (quarter - 1) * 3;
                const endMonth = startMonth + 2;
                start = new Date(y, startMonth, 1);
                end = new Date(y, endMonth + 1, 0);
            } else {
                // Chỉ chọn năm -> lấy cả năm
                start = new Date(y, 0, 1);
                end = new Date(y, 11, 31);
            }

            return {
                startDate: this.formatDate(start),
                endDate: this.formatDate(end)
            };
        }

        formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        /**
         * Tính toán số liệu tổng quan từ danh sách thống kê sách
         * vì backend hiện chỉ trả về list (không có endpoint summary riêng).
         */
        calculateSummary(stats) {
            if (!Array.isArray(stats) || stats.length === 0) {
                return {
                    totalBorrowCount: 0,
                    totalBooks: 0,
                    currentBorrowed: 0,
                    mostBorrowedCategory: 'N/A'
                };
            }

            let totalBorrowCount = 0;
            let currentBorrowed = 0;
            const categoryBorrowCount = {};

            stats.forEach(stat => {
                totalBorrowCount += stat.borrowCount || 0;
                currentBorrowed += stat.currentBorrowed || 0;

                const category = stat.category || 'Khác';
                categoryBorrowCount[category] = (categoryBorrowCount[category] || 0) + (stat.borrowCount || 0);
            });

            let mostBorrowedCategory = 'N/A';
            let maxBorrow = 0;
            Object.entries(categoryBorrowCount).forEach(([cat, count]) => {
                if (count > maxBorrow) {
                    maxBorrow = count;
                    mostBorrowedCategory = cat;
                }
            });

            return {
                totalBorrowCount,
                totalBooks: stats.length,
                currentBorrowed,
                mostBorrowedCategory
            };
        }

        /**
         * Gán thứ hạng (rank) cho từng sách dựa trên số lượt mượn (borrowCount).
         * - Danh sách đã được sắp xếp giảm dần theo COUNT ở backend.
         * - Nếu cùng số lượt mượn -> cùng hạng.
         * - Hạng tiếp theo được tính dựa trên số lượng sách có lượt mượn cao hơn.
         */
        assignRanks(stats) {
            if (!Array.isArray(stats)) return [];

            let lastBorrowCount = null;
            let lastRank = 0;
            let index = 0;

            return stats.map(stat => {
                index++;
                const currentCount = stat.borrowCount || 0;

                if (lastBorrowCount === null) {
                    // Phần tử đầu tiên
                    lastRank = 1;
                } else if (currentCount !== lastBorrowCount) {
                    // Khác số lượt mượn -> hạng = vị trí hiện tại (competition ranking)
                    lastRank = index;
                }

                lastBorrowCount = currentCount;

                return {
                    ...stat,
                    rank: lastRank
                };
            });
        }

        async handleFilterChange(type, value) {
            const actualValue = value === 'Bỏ trống' ? null :
                               (type === 'year' ? parseInt(value) :
                                type === 'quarter' ? parseInt(value) :
                                type === 'month' ? parseInt(value) : null);

            this.model.setFilter(type, actualValue);
            this.view.updateFilterDisplay(type, actualValue);
            this.view.closeAllDropdowns();
            await this.loadData();
        }

        handlePageChange(page) {
            this.model.setPage(page);
            this.render();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        handleRowClick(bookId) {
            // Navigate to Book detail page
            window.location.href = `book.html?id=${encodeURIComponent(bookId)}`;
        }

        handleBorrowClick(bookId) {
            // Navigate to BorrowBook page with bookId
            window.location.href = `BorrowBook.html?bookId=${encodeURIComponent(bookId)}`;
        }

        render() {
            this.view.renderSummary(this.model.summary);
            this.view.renderTable(this.model.getPageData());
            this.view.renderPagination(this.model.currentPage, this.model.getTotalPages());
        }
    }

    // ==================== INIT APP ====================
    let bookStatsController;
    document.addEventListener('DOMContentLoaded', () => {
        const model = new BookStatsModel();
        const view = new BookStatsView();
        bookStatsController = new BookStatsController(model, view);
    });
</script>
</body>
</html>